#!/bin/bash

if [ -z "$1" ]
  then
    printf "Usage: $0 <image>\n\nThis script uses image-inspector to scan the provide image for CVEs.\nThe results (xml and html) are placed in the current directory.\nA non-zero status is returned if any CVEs are detected."    
    exit 1
fi

WORKING_DIR=$(mktemp -d -t cve-scan-XXXXX)
IMAGE_CONTENT=${WORKING_DIR}/image-content
mkdir ${IMAGE_CONTENT}

image-inspector --image=$1 \
                --path=${IMAGE_CONTENT} \
                --scan-results-dir=${WORKING_DIR} \
                --scan-type=openscap \
                --openscap-html-report

mv ${WORKING_DIR}/results.* .

rm -fr ${WORKING_DIR}

grep "0 failed" results.html